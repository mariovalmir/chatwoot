version: "3.8"

services:
  waha:
    image: devlikeapro/waha:latest
    environment:
      # ===== Configurações básicas =====
      - TZ=America/Sao_Paulo
      - WHATSAPP_API_KEY=supersecreta123                # API Key para autenticação
      - WHATSAPP_API_PORT=3000                          # Porta do serviço
      - WHATSAPP_LOG_LEVEL=info
      
      # ===== Credenciais Dashboard/Swagger =====
      - WAHA_DASHBOARD_USERNAME=admin                   # Usuário do dashboard
      - WAHA_DASHBOARD_PASSWORD=0175ff3b3e4f46d6bd260b9885f813bd
      - WHATSAPP_SWAGGER_USERNAME=admin                 # Usuário da documentação API
      - WHATSAPP_SWAGGER_PASSWORD=0175ff3b3e4f46d6bd260b9885f813bd
      
      # ===== Webhook para Chatwoot =====
      - WHATSAPP_HOOK_URL=https://chatwoot.flowzapp.com.br/webhooks/whatsapp
      - WHATSAPP_HOOK_EVENTS=*                          # Receber todos os eventos
      
      # ===== Armazenamento =====
      - WHATSAPP_FILES_FOLDER=/app/data/files           # Pasta de arquivos
      
    ports:
      - "3000:3000"                                     # Expor porta para Traefik
    env_file:
      - .env.waha
      
    volumes:
      - waha_data:/app/data                            # Persistência das sessões
      
    networks:
      - traefik_public
      
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "--header=X-Api-Key:supersecreta123", "http://localhost:3000/api/sessions"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
      labels:
        - traefik.enable=true
        
        # HTTP Router
        - traefik.http.routers.waha.rule=Host(`waha.flowzapp.com.br`)
        - traefik.http.routers.waha.entrypoints=websecure
        - traefik.http.routers.waha.tls=true
        - traefik.http.routers.waha.tls.certresolver=le
        
        # Service
        - traefik.http.services.waha.loadbalancer.server.port=3000
        - traefik.http.services.waha.loadbalancer.passhostheader=true
        
        # Middleware para timeout
        - traefik.http.middlewares.waha-timeout.timeout.idle=300s
        - traefik.http.routers.waha.middlewares=waha-timeout
        
  # Create a dedicated router for health checks that injects the API key
  - traefik.http.routers.waha-health.rule=Host(`waha.flowzapp.com.br`) && Path(`/health`)
  - traefik.http.routers.waha-health.entrypoints=websecure
  - traefik.http.routers.waha-health.tls=true
  - traefik.http.routers.waha-health.service=waha
  - traefik.http.routers.waha-health.middlewares=waha-add-apikey

  # Middleware to add API key header for health probe
  - traefik.http.middlewares.waha-add-apikey.headers.customrequestheaders.X-Api-Key=supersecreta123

  # Docker Swarm - necessário para que o Traefik encontre o serviço
  - traefik.docker.network=traefik_public

volumes:
  waha_data:
    driver: local

networks:
  traefik_public:
    external: true
